
SET IDENTITY_INSERT [dbo].[EntityType] ON 
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (1,'h*','Hospitals','HO','Hospitals','Hospitals',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (2,'hb','Hospitals - Buying Group','2 ','Hospitals - Buying Group','Hospitals - Buying Group',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (3,'hg','Hospitals - Public','2 ','Hospitals - Public','Hospitals - Public',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (4,'hm','Hospitals - Manufacturer','2 ','Hospitals - Manufacturer','Hospitals - Manufacturer',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (5,'hp','Hospitals - Private','2 ','Hospitals - Private','Hospitals - Private',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (6,'hv','Hospitals - HIV clinics','2 ','Hospitals - HIV clinics','Hospitals - HIV clinics',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (7,'o*','Generic Outlets','O','Generic Outlets','Generic Outlets',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (8,'o1','Prison','G1','Prison','Prison',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (9,'o2','Day Surgery','H1','Day Surgery','Day Surgery',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (10,'o3','Exports and Online','E2','Exports and Online','Exports and Online',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (11,'oa','Promotional','M1','Promotional','Promotional',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (12,'ob','Charities, blind society','Q3','Charities, blind society','Charities, blind society',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (13,'oc','Pfizer Ad Hoc','P1','Pfizer Ad Hoc','Pfizer Ad Hoc',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (14,'od','Dentist or Dental Clinic','H8','Dentist or Dental Clinic','Dentist or Dental Clinic',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (15,'oe','Overseas Companies','E1','Overseas Companies','Overseas Companies',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (16,'of','Postcode Level Data','1 ','Postcode Level Data','Postcode Level Data',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (17,'og','Government','3 ','Government','Government',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (18,'oh','Priceline Store','B1','Priceline Store','Priceline Store',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (19,'oi','Branch account','W4','Branch account','Branch account',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (20,'oj','Ambulance','H7','Ambulance','Ambulance',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (21,'ol','Samples','L1','Samples','Samples',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (22,'om','Clinics and Medical Centres','H5','Clinics and Medical Centres','Clinics and Medical Centres',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (23,'on','Aged and Community Healthcare','H6','Aged and Community Healthcare','Aged and Community Healthcare',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (24,'oo','Others, Misc, Companies','M2','Others, Misc, Companies','Others, Misc, Companies',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (25,'op','Spare 550-559','S5','Spare 550-559','Spare 550-559',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (26,'oq','Surgical suppliers','W3','Surgical suppliers','Surgical suppliers',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (27,'or','Research, Schools, Unis','Q1','Research, Schools, Unis','Research, Schools, Unis',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (28,'os','Staff','M3','Staff','Staff',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (29,'ot','Test orders','M4','Test orders','Test orders',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (30,'ou','Colostomy, Ileostomy assoc','S4','Colostomy, Ileostomy assoc','Colostomy, Ileostomy assoc',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (31,'ov','Veterinary clinics & suppliers','W2','Veterinary clinics & suppliers','Veterinary clinics & suppliers',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (32,'ow','IMS data suppliers','W1','IMS data suppliers','IMS data suppliers',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (33,'ox','Department Stores','Q2','Department Stores','Department Stores',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (34,'oy','Spare 570-579','S1','Spare 570-579','Spare 570-579',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (35,'oz','Cash Account','M5','Cash Account','Cash Account',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (36,'p*','Pharmacies','Ph','Pharmacies','Pharmacies',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (37,'pb','Pharmacy Buying Group','1 ','Pharmacy Buying Group','Pharmacy Buying Group',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (38,'pd','Dispensing Doctors','1 ','Dispensing Doctors','Dispensing Doctors',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (39,'pr','Retail Pharmacy','1 ','Retail Pharmacy','Retail Pharmacy',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (40,'s*','Panel Supplier','S','Panel Supplier','Panel Supplier',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (41,'sc','Panel Combined Supplier','SC','Panel Combined Supplier','Panel Combined Supplier',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (42,'sh','Panel Hospital Supplier','SH','Panel Hospital Supplier','Panel Hospital Supplier',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (43,'si','Panel Ignore Supplier','SI','Panel Ignore Supplier','Panel Ignore Supplier',1)
INSERT INTO ENTITYTYPE ([EntityTypeId], [EntityTypeCode], [EntityTypeName], [Abbrev], [Display], [Description], [IsActive]) VALUES (44,'sp','Panel Pharmacy Supplier','SP','Panel Pharmacy Supplier','Panel Pharmacy Supplier',1)
SET IDENTITY_INSERT [dbo].[EntityType] OFF 



GO


--1 - retail
--2 - hospital
--5 - other

update e
set e.DataTypeId = 1
from EntityType e
inner join irp.OutletMaster om on e.entitytypecode = om.entity_type
inner join irp.OutletType o on om.out_type = o.OutletType
where o.OutletCategory = 'R'

update e
set e.DataTypeId = 2
from EntityType e
inner join irp.OutletMaster om on e.entitytypecode = om.entity_type
inner join irp.OutletType o on om.out_type = o.OutletType
where o.OutletCategory = 'H'

update e
set e.DataTypeId = 10
from EntityType e
inner join irp.OutletMaster om on e.entitytypecode = om.entity_type
inner join irp.OutletType o on om.out_type = o.OutletType
where o.OutletCategory = 'O'

GO


--entity type table - mapped to DataType
--deliverables to entity type
--iam entity type from items table
--non iam outlettype - outlet master - entity type
--add all entity types for the category (datatype) where non iam outlettype is empty


IF OBJECT_ID('tempdb..#SubChannels') IS NOT NULL
begin
        drop table #SubChannels
end

CREATE TABLE #SubChannels
( 
  [DeliverableId] int
, [EntityTypeId] int
)

--get the entity type id for entries in items table
insert into #SubChannels (EntityTypeId, DeliverableId) select e.EntityTypeId, dl.DeliverableId 
from irp.ReportParameter rp
join irp.Dimension d on rp.VersionTo = 32767 and d.VersionTo = 32767
and rp.Code= 'DimChannel' and rp.Value = d.DimensionID
join irp.Items i on i.Versionto = 32767 and i.DimensionID = d.DimensionID and i.item is not null
join DeliveryReport dr on dr.ReportID = rp.ReportID
join Deliverables dl on dr.DeliverableId = dl.DeliverableId
join EntityType e on i.Item = e.EntityTypeCode

--get the entity type id for entries matching in 'RGPF CC TABLE OUTPUT TYPES - entity types' column in irg_cat_sel
insert into #SubChannels (EntityTypeId, DeliverableId) select e.EntityTypeId, d.DeliverableId from DeliveryReport dr
join deliverables d on dr.DeliverableId =dr.DeliverableId and d.DeliveryTypeId in (1,2) 
join subscription s on d.SubscriptionId = s.SubscriptionId
join clients c on s.ClientId = c.id
join irp.cld cld on cld.RPT_NO = dr.ReportNo and cld.CLIENT_NO = c.IRPClientNo
join 
--split the comma separated entry and find the entity type
(SELECT A.Cat, Split.a.value('.', 'VARCHAR(100)') AS String  
FROM  (SELECT [RGPF CC TABLE OUTPUT TYPES - entity types],  Cat, 
     CAST ('<M>' + REPLACE([RGPF CC TABLE OUTPUT TYPES - entity types], ',', '</M><M>') + '</M>' AS XML) AS String  
	 FROM  [IRG_CAT_SEL]) AS A CROSS APPLY String.nodes ('/M') AS Split(a)) b
	 on b.cat = cld.cat_sel and b.String is not null and b.String <> ''
	 join irp.OutletMaster om on om.out_type = ltrim(rtrim(b.String))
	 join EntityType e on e.entitytypecode = om.entity_type

--get all entity type ids for retail / hospital / other if entries in 'RGPF CC TABLE OUTPUT TYPES - entity types' column in irg_cat_sel which is empty
insert into #SubChannels (EntityTypeId, DeliverableId) select e.EntityTypeId, d.DeliverableId from DeliveryReport dr
join deliverables d on dr.DeliverableId =dr.DeliverableId and d.DeliveryTypeId in (1,2) 
join subscription s on d.SubscriptionId = s.SubscriptionId
join clients c on s.ClientId = c.id
join irp.cld cld on cld.RPT_NO = dr.ReportNo and cld.CLIENT_NO = c.IRPClientNo
join [IRG_CAT_SEL] cat on cat.Cat = cld.CAT_SEL and ([RGPF CC TABLE OUTPUT TYPES - entity types] is null or RTRIM(LTRIM([RGPF CC TABLE OUTPUT TYPES - entity types])) = '')
join irp.OutletType ot on cat.DataType = ot.OutletCategoryName
join irp.outletmaster om on om.out_type = ot.OutletType
join EntityType e on e.EntityTypeCode = om.entity_type

MERGE INTO subchannels AS sc
USING (SELECT entitytypeid,deliverableid FROM #subchannels group by entitytypeid,deliverableid) AS tsc 
ON (tsc.entitytypeid = sc.entitytypeid and tsc.deliverableid = sc.deliverableid) 
WHEN NOT MATCHED THEN  
    INSERT (entitytypeid, deliverableid) 
    VALUES (tsc.entitytypeid, tsc.deliverableid); 

drop table #SubChannels


GO

update dbo.DataType set IsChannel=1 where Name in ('Retail','Hospital','Other Outlet')

GO

